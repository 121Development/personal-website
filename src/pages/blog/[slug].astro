---
import Layout from '../../layouts/Layout.astro';
import { fetchBlogPost, fetchBlogPosts } from '../../lib/content';

export async function getStaticPaths() {
  const posts = await fetchBlogPosts();

  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post }
  }));
}

const { slug } = Astro.params;
const { post } = Astro.props;

if (!post) {
  return Astro.redirect('/blog');
}

const siteUrl = "https://121eliasson.com";
const postUrl = `${siteUrl}/blog/${post.slug}`;
const ogImage = post.image || "/images/og-default.png";

// Generate keywords from title and tags
const titleWords = post.title.toLowerCase().split(/\s+/).filter(w => w.length > 3);
const tagWords = post.tags || [];
const keywords = [...new Set([...titleWords, ...tagWords, 'erik eliasson'])].join(', ');

// Article structured data
const articleSchema = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": post.title,
  "description": post.excerpt || post.title,
  "image": ogImage.startsWith('http') ? ogImage : `${siteUrl}${ogImage}`,
  "datePublished": post.date,
  "dateModified": post.date,
  "author": {
    "@type": "Person",
    "name": "Erik Eliasson",
    "url": siteUrl
  },
  "publisher": {
    "@type": "Person",
    "name": "Erik Eliasson",
    "url": siteUrl
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": postUrl
  },
  "url": postUrl
};
---

<Layout
  title={`${post.title} - 121Eliasson`}
  description={post.excerpt || `Read ${post.title} by Erik Eliasson`}
  image={ogImage}
  type="article"
  publishedDate={post.date}
  keywords={keywords}
>
  <article itemscope itemtype="https://schema.org/BlogPosting">
    <meta itemprop="datePublished" content={post.date}>
    <meta itemprop="author" content="Erik Eliasson">

    <div class="post-meta">
      <time datetime={post.date} itemprop="datePublished" class="post-date">{post.date}</time>
      {post.tags && post.tags.length > 0 && (
        <span class="post-tags">
          {post.tags.map((tag: string) => (
            <a href={`/blog?tag=${tag}`} class="tag">{tag}</a>
          ))}
        </span>
      )}
    </div>
    <h1 itemprop="headline">{post.title}</h1>
    <div class="content" itemprop="articleBody" set:html={post.content} />
  </article>

  <div class="post-actions">
    <a href="/blog" class="back-link">‚Üê Back to blog</a>
    <a href={`/edit?slug=${post.slug}`} class="edit-link">Edit post</a>
  </div>

  <!-- Article Structured Data -->
  <script type="application/ld+json" set:html={JSON.stringify(articleSchema)} />
</Layout>

<style>
  .post-meta {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
    flex-wrap: wrap;
  }

  .post-date {
    color: var(--text-muted);
    font-size: 0.85rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .post-tags {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .tag {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.8rem;
    color: var(--text-muted);
    font-weight: 500;
    text-decoration: none;
    transition: all var(--transition);
  }

  .tag:hover {
    background: var(--accent);
    border-color: var(--accent);
    color: white;
  }

  .post-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 2rem;
    padding-top: 1rem;
    border-top: 1px solid var(--border);
  }

  .edit-link {
    color: var(--text-muted);
    font-size: 0.9rem;
    text-decoration: none;
    padding: 0.5rem 1rem;
    border: 1px solid var(--border);
    border-radius: 6px;
    transition: all var(--transition);
  }

  .edit-link:hover {
    color: var(--accent);
    border-color: var(--accent);
  }
</style>
